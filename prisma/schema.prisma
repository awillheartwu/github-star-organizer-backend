// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

generator prismabox {
  provider     = "prismabox"
  output       = "../src/generated/prismabox"
  typebox      = true
  useJsonTypes = true
  inputModels  = true
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

/// å½’æ¡£åŸå› 
enum ArchivedReason {
  manual     // æ‰‹åŠ¨åˆ é™¤
  unstarred  // åŒæ­¥æ£€æµ‹åˆ°å·²å–æ¶ˆ star
}

model Project {
  id          String    @id @default(uuid()) // ä¸»é”®ï¼ŒUUID
  githubId    Int       @unique // GitHub é¡¹ç›®çš„å”¯ä¸€ IDï¼ˆæ¥è‡ª GitHub APIï¼‰
  name        String // ä»“åº“åç§°ï¼ˆå¦‚ star-organizerï¼‰
  fullName    String // ä»“åº“å…¨åï¼ˆå¦‚ user/star-organizerï¼‰
  url         String // ä»“åº“é“¾æ¥
  description String? // é¡¹ç›®æè¿°
  language    String? // ä¸»è¯­è¨€
  stars       Int       @default(0) // Star æ•°é‡
  forks       Int       @default(0) // Fork æ•°é‡
  lastCommit  DateTime? // æœ€åä¸€æ¬¡æäº¤æ—¶é—´ï¼ˆå¯é€‰ï¼‰
  lastSyncAt  DateTime  @default(now()) // æœ€ååŒæ­¥æ—¶é—´
  touchedAt   DateTime? // æœ€è¿‘ä¸€æ¬¡è¢«åŒæ­¥ä»»åŠ¡â€œè§¦è¾¾â€çš„æ—¶é—´ï¼ˆå†…å®¹æœªå˜ä¹Ÿä¼šæ›´æ–°ï¼‰

  // Custom info
  notes      String? // ç”¨æˆ·å¤‡æ³¨
  favorite   Boolean     @default(false) // æ˜¯å¦æ ‡è®°ä¸ºæ”¶è—
  archived   Boolean     @default(false) // æ˜¯å¦å½’æ¡£
  pinned     Boolean     @default(false) // æ˜¯å¦ç½®é¡¶
  score      Int? // ç”¨æˆ·è¯„åˆ†ï¼ˆå¯é€‰ï¼‰
  videoLinks VideoLink[] // å…³è”çš„è§†é¢‘é“¾æ¥ï¼ˆå¤šå¯¹ä¸€ï¼‰

  // Relations
  tags ProjectTag[] // é¡¹ç›®å…³è”çš„æ ‡ç­¾ï¼ˆå¤šå¯¹å¤šï¼‰

  createdAt DateTime  @default(now()) // åˆ›å»ºæ—¶é—´
  updatedAt DateTime  @default(now()) @updatedAt // æ›´æ–°æ—¶é—´ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
  deletedAt DateTime? // è½¯åˆ é™¤æ—¶é—´ï¼ˆå¯é€‰ï¼‰

  // ğŸ”½ ç´¢å¼•åŒºï¼ˆæ–°å¢ï¼‰
  @@index([archived, createdAt]) // å¸¸ç”¨ where archived=false æ’åº createdAt
  @@index([archived, updatedAt]) // æœ€è¿‘æ›´æ–°
  @@index([stars])
  @@index([forks])
  @@index([score])
  @@index([language])
  @@index([lastCommit])
  @@index([lastSyncAt])
  @@index([touchedAt])
  @@index([name]) // name æ¨¡ç³ŠåŒ¹é…ä¹Ÿæœ‰å¸®åŠ©ï¼ˆSQLite é‡Œä½œç”¨æœ‰é™ï¼Œä½†ä¿ç•™å¯è¯»æ€§ï¼‰
}

model Tag {
  id          String       @id @default(uuid()) // ä¸»é”®ï¼ŒUUID
  name        String // æ ‡ç­¾åç§°ï¼ˆå”¯ä¸€ï¼‰ ä¿®æ­£,è€ƒè™‘è½¯åˆ ,ä¸å†å”¯ä¸€
  description String? // æ ‡ç­¾æè¿°ï¼ˆå¯é€‰ï¼‰
  projects    ProjectTag[] // æ‹¥æœ‰è¯¥æ ‡ç­¾çš„é¡¹ç›®ï¼ˆå¤šå¯¹å¤šï¼‰

  archived  Boolean   @default(false) // æ˜¯å¦å½’æ¡£
  createdAt DateTime  @default(now()) // åˆ›å»ºæ—¶é—´
  updatedAt DateTime  @default(now()) @updatedAt // æ›´æ–°æ—¶é—´ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
  deletedAt DateTime? // è½¯åˆ é™¤æ—¶é—´ï¼ˆå¯é€‰ï¼‰

  @@index([archived, createdAt]) // å¸¸ç”¨ where archived=false æ’åº createdAt
  @@index([name]) // name æ¨¡ç³ŠåŒ¹é…ä¹Ÿæœ‰å¸®åŠ©ï¼ˆSQLite é‡Œä½œç”¨æœ‰é™ï¼Œä½†ä¿ç•™å¯è¯»æ€§ï¼‰
}

model ProjectTag {
  project   Project @relation(fields: [projectId], references: [id]) // å¤–é”®å…³è” Project
  projectId String

  tag   Tag    @relation(fields: [tagId], references: [id]) // å¤–é”®å…³è” Tag
  tagId String

  @@id([projectId, tagId]) // è”åˆä¸»é”®ï¼Œç¡®ä¿ project ä¸ tag çš„å”¯ä¸€ç»„åˆ
  // ğŸ”½ å¸¸ç”¨è¿æ¥æ–¹å‘éƒ½å»ºç´¢å¼•
  @@index([projectId])
  @@index([tagId])
}

model VideoLink {
  id        String  @id @default(uuid()) // ä¸»é”®
  url       String // è§†é¢‘é“¾æ¥
  project   Project @relation(fields: [projectId], references: [id]) // æ‰€å±é¡¹ç›®
  projectId String // å¤–é”®

  archived  Boolean   @default(false) // æ˜¯å¦å½’æ¡£
  createdAt DateTime  @default(now()) // åˆ›å»ºæ—¶é—´
  updatedAt DateTime  @default(now()) @updatedAt // æ›´æ–°æ—¶é—´ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
  deletedAt DateTime? // è½¯åˆ é™¤æ—¶é—´ï¼ˆå¯é€‰ï¼‰

  @@index([projectId])
  @@index([archived, createdAt]) // å¸¸ç”¨ where archived=false æ’åº createdAt
}

enum UserRole {
  USER
  ADMIN
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  displayName  String?
  role         UserRole @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  refreshTokens RefreshToken[]

  @@index([createdAt])
}

model RefreshToken {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // åªå­˜å“ˆå¸Œï¼ˆé¿å…æ˜æ–‡è½åº“ï¼‰
  tokenHash String @unique
  jti       String @unique

  revoked           Boolean  @default(false)
  replacedByTokenId String?
  expiresAt         DateTime
  createdAt         DateTime @default(now())

  ip        String?
  userAgent String?

  @@index([userId])
  @@index([revoked, expiresAt])
}

/// è®°å½•å„ç±»åŒæ­¥ä»»åŠ¡çš„æ¸¸æ ‡ä¸çŠ¶æ€
/// å…¼å®¹å¤šæ¥æºä¸å¤šä»»åŠ¡ï¼Œé€šè¿‡ (source, key) å”¯ä¸€å®šä½ã€‚
model SyncState {
  id           String   @id @default(uuid())

  /// åŒæ­¥æ¥æºï¼šä¾‹å¦‚ 'github:stars'
  source       String

  /// ä»»åŠ¡é”®ï¼šä¾‹å¦‚ 'user:YOUR_GITHUB_USERNAME'
  key          String

  /// ç”¨äºå¢é‡åŒæ­¥çš„æ¸¸æ ‡ï¼ˆä¾‹å¦‚ GitHub starred_at çš„ ISO å­—ç¬¦ä¸²ï¼‰
  cursor       String?   // e.g. "2025-09-01T05:11:22Z"

  /// HTTP ETagï¼ˆIf-None-Match/304ï¼‰ï¼Œå¯é€‰åŠ é€Ÿ
  etag         String?

  /// æœ€è¿‘ä¸€æ¬¡è¿è¡Œæ—¶é—´/æˆåŠŸæ—¶é—´/å¤±è´¥æ—¶é—´
  lastRunAt     DateTime? 
  lastSuccessAt DateTime?
  lastErrorAt   DateTime?

  /// æœ€è¿‘ä¸€æ¬¡é”™è¯¯ä¿¡æ¯ï¼ˆç®€è¦ï¼‰
  lastError     String?

  /// æœ€è¿‘ä¸€æ¬¡ç»Ÿè®¡ä¿¡æ¯ï¼ˆJSON ä¸²ï¼Œè®°å½• created/updated ç­‰ï¼‰
  statsJson    String?

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now()) @updatedAt

  @@unique([source, key])  // ä¸€ä¸ªæ¥æº+é”®åªä¿ç•™ä¸€æ¡çŠ¶æ€
  @@index([source])
  @@index([updatedAt])
}

/// å½’æ¡£çš„ Project å¿«ç…§ï¼ˆå…è®¸åŒä¸€ githubId å¤šæ¬¡å½’æ¡£ï¼‰
model ArchivedProject {
  id                String          @id @default(uuid())
  githubId          Int?
  originalProjectId String?
  reason            ArchivedReason
  snapshot          Json
  archivedAt        DateTime        @default(now())

  @@index([githubId])
  @@index([archivedAt])
  @@index([reason])
}
