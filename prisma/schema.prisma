// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

generator prismabox {
  provider     = "prismabox"
  output       = "../src/generated/prismabox"
  typebox      = true
  useJsonTypes = true
  inputModels  = true
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

/// å½’æ¡£åŸå› 
enum ArchivedReason {
  manual // æ‰‹åŠ¨åˆ é™¤
  unstarred // åŒæ­¥æ£€æµ‹åˆ°å·²å–æ¶ˆ star
}

/// GitHub é¡¹ç›®ï¼ˆæ¥è‡ª stars åŒæ­¥ï¼‰ä¸ç”¨æˆ·ä¾§æ ‡æ³¨ä¿¡æ¯
model Project {
  /// ä¸»é”®ï¼ŒUUID
  id          String    @id @default(uuid())
  /// GitHub é¡¹ç›®çš„å”¯ä¸€ IDï¼ˆæ¥è‡ª GitHub APIï¼‰
  githubId    Int       @unique
  /// ä»“åº“åç§°ï¼ˆå¦‚ star-organizerï¼‰
  name        String
  /// ä»“åº“å…¨åï¼ˆå¦‚ user/star-organizerï¼‰
  fullName    String
  /// ä»“åº“é“¾æ¥
  url         String
  /// é¡¹ç›®æè¿°
  description String?
  /// ä¸»è¯­è¨€
  language    String?
  /// Star æ•°é‡
  stars       Int       @default(0)
  /// Fork æ•°é‡
  forks       Int       @default(0)
  /// æœ€åä¸€æ¬¡æäº¤æ—¶é—´ï¼ˆå¯é€‰ï¼‰
  lastCommit  DateTime?
  /// æœ€ååŒæ­¥æ—¶é—´
  lastSyncAt  DateTime  @default(now())
  /// æœ€è¿‘ä¸€æ¬¡è¢«åŒæ­¥ä»»åŠ¡â€œè§¦è¾¾â€çš„æ—¶é—´ï¼ˆå†…å®¹æœªå˜ä¹Ÿä¼šæ›´æ–°ï¼‰
  touchedAt   DateTime?

  // Custom info
  /// ç”¨æˆ·å¤‡æ³¨
  notes        String?
  /// æ˜¯å¦æ ‡è®°ä¸ºæ”¶è—
  favorite     Boolean     @default(false)
  /// æ˜¯å¦å½’æ¡£
  archived     Boolean     @default(false)
  /// æ˜¯å¦ç½®é¡¶
  pinned       Boolean     @default(false)
  /// ç”¨æˆ·è¯„åˆ†ï¼ˆå¯é€‰ï¼‰
  score        Int?
  /// å…³è”çš„è§†é¢‘é“¾æ¥ï¼ˆå¤šå¯¹ä¸€ï¼‰
  videoLinks   VideoLink[]
  /// æœ€æ–° AI æ‘˜è¦ï¼ˆçŸ­ï¼‰
  summaryShort String?
  /// æœ€æ–° AI æ‘˜è¦ï¼ˆé•¿ï¼‰
  summaryLong  String?

  /// é¡¹ç›®å…³è”çš„æ ‡ç­¾ï¼ˆå¤šå¯¹å¤šï¼‰
  tags ProjectTag[]

  /// åˆ›å»ºæ—¶é—´
  createdAt DateTime  @default(now())
  /// æ›´æ–°æ—¶é—´ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
  updatedAt DateTime  @default(now()) @updatedAt
  /// è½¯åˆ é™¤æ—¶é—´ï¼ˆå¯é€‰ï¼‰
  deletedAt DateTime?

  AiSummary AiSummary[]

  // ğŸ”½ ç´¢å¼•åŒºï¼ˆæ–°å¢ï¼‰
  @@index([archived, createdAt]) // å¸¸ç”¨ where archived=false æ’åº createdAt
  @@index([archived, updatedAt]) // æœ€è¿‘æ›´æ–°
  @@index([stars])
  @@index([forks])
  @@index([score])
  @@index([language])
  @@index([lastCommit])
  @@index([lastSyncAt])
  @@index([touchedAt])
  @@index([name]) // name æ¨¡ç³ŠåŒ¹é…ä¹Ÿæœ‰å¸®åŠ©ï¼ˆSQLite é‡Œä½œç”¨æœ‰é™ï¼Œä½†ä¿ç•™å¯è¯»æ€§ï¼‰
}

/// å†å² AI æ‘˜è¦ï¼ˆä¾¿äºè¿½æº¯ä¸åŒæ¨¡å‹/æ—¶é—´çš„ç»“æœï¼‰
enum AiSummaryStyle {
  short
  long
}

/// AI æ‘˜è¦å†å²è®°å½•
model AiSummary {
  /// ä¸»é”®
  id        String  @id @default(uuid())
  /// æ‰€å±é¡¹ç›®
  projectId String
  /// å¤–é”®
  project   Project @relation(fields: [projectId], references: [id])

  /// æ‘˜è¦é£æ ¼
  style   AiSummaryStyle
  /// ä½¿ç”¨çš„æ¨¡å‹
  content String
  /// æ¨¡å‹åç§°
  model   String?
  /// æ¨¡å‹ç‰ˆæœ¬
  lang    String?
  /// ä½¿ç”¨çš„ tokens æ•°ï¼ˆå¯é€‰ï¼‰
  tokens  Int?

  createdAt DateTime @default(now())

  @@index([projectId, createdAt])
  @@index([style])
}

/// æ ‡ç­¾è¡¨
model Tag {
  /// ä¸»é”®ï¼ŒUUID
  id          String       @id @default(uuid())
  /// æ ‡ç­¾åç§°ï¼ˆä¸å†å”¯ä¸€ï¼Œé è½¯åˆ åŒºåˆ†ï¼‰
  name        String
  /// æ ‡ç­¾æè¿°ï¼ˆå¯é€‰ï¼‰
  description String?
  /// æ‹¥æœ‰è¯¥æ ‡ç­¾çš„é¡¹ç›®ï¼ˆå¤šå¯¹å¤šï¼‰
  projects    ProjectTag[]

  /// æ˜¯å¦å½’æ¡£
  archived  Boolean   @default(false)
  /// åˆ›å»ºæ—¶é—´
  createdAt DateTime  @default(now())
  /// æ›´æ–°æ—¶é—´ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
  updatedAt DateTime  @default(now()) @updatedAt
  /// è½¯åˆ é™¤æ—¶é—´ï¼ˆå¯é€‰ï¼‰
  deletedAt DateTime?

  @@index([archived, createdAt]) // å¸¸ç”¨ where archived=false æ’åº createdAt
  @@index([name]) // name æ¨¡ç³ŠåŒ¹é…ä¹Ÿæœ‰å¸®åŠ©ï¼ˆSQLite é‡Œä½œç”¨æœ‰é™ï¼Œä½†ä¿ç•™å¯è¯»æ€§ï¼‰
}

/// é¡¹ç›®-æ ‡ç­¾ å…³è”è¡¨
model ProjectTag {
  /// å¤–é”®å…³è” Project
  project   Project @relation(fields: [projectId], references: [id])
  projectId String

  /// å¤–é”®å…³è” Tag
  tag   Tag    @relation(fields: [tagId], references: [id])
  tagId String

  @@id([projectId, tagId]) // è”åˆä¸»é”®ï¼Œç¡®ä¿ project ä¸ tag çš„å”¯ä¸€ç»„åˆ
  // ğŸ”½ å¸¸ç”¨è¿æ¥æ–¹å‘éƒ½å»ºç´¢å¼•
  @@index([projectId])
  @@index([tagId])
}

/// è§†é¢‘é“¾æ¥
model VideoLink {
  /// ä¸»é”®
  id        String  @id @default(uuid())
  /// è§†é¢‘é“¾æ¥
  url       String
  /// æ‰€å±é¡¹ç›®
  project   Project @relation(fields: [projectId], references: [id])
  /// å¤–é”®
  projectId String

  /// æ˜¯å¦å½’æ¡£
  archived  Boolean   @default(false)
  /// åˆ›å»ºæ—¶é—´
  createdAt DateTime  @default(now())
  /// æ›´æ–°æ—¶é—´ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
  updatedAt DateTime  @default(now()) @updatedAt
  /// è½¯åˆ é™¤æ—¶é—´ï¼ˆå¯é€‰ï¼‰
  deletedAt DateTime?

  @@index([projectId])
  @@index([archived, createdAt]) // å¸¸ç”¨ where archived=false æ’åº createdAt
}

/// ç”¨æˆ·è§’è‰²
enum UserRole {
  USER
  ADMIN
}

/// ç”¨æˆ·è¡¨
model User {
  /// ä¸»é”®ï¼ŒUUID
  id           String   @id @default(uuid())
  /// ç”¨æˆ·é‚®ç®±
  email        String   @unique
  /// å¯†ç å“ˆå¸Œ
  passwordHash String
  /// æ˜¾ç¤ºåç§°
  displayName  String?
  /// ç”¨æˆ·è§’è‰²
  role         UserRole @default(USER)
  /// ä»¤ç‰Œç‰ˆæœ¬ï¼ˆç”¨äºåˆ·æ–°ä»¤ç‰Œçš„æ— çŠ¶æ€æ’¤é”€ï¼‰
  tokenVersion Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  refreshTokens RefreshToken[]

  @@index([createdAt])
  @@index([tokenVersion])
}

/// Refresh Tokenï¼ˆä»…å­˜å“ˆå¸Œï¼‰
model RefreshToken {
  id     String @id @default(uuid())
  /// æ‰€å±ç”¨æˆ·
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// åªå­˜å“ˆå¸Œï¼ˆé¿å…æ˜æ–‡è½åº“ï¼‰
  tokenHash String @unique
  // ä¹Ÿå¯ä»¥ç”¨ jtiï¼ˆJWT IDï¼‰æ¥å”¯ä¸€æ ‡è¯†
  jti       String @unique

  /// åªå­˜å“ˆå¸Œï¼ˆé¿å…æ˜æ–‡è½åº“ï¼‰
  revoked           Boolean   @default(false)
  /// æ›¿æ¢çš„ä»¤ç‰Œ IDï¼ˆå¯é€‰ï¼Œç”¨äºå•ç‚¹ç™»å½•ç­‰ï¼‰
  replacedByTokenId String?
  /// è¿‡æœŸæ—¶é—´
  expiresAt         DateTime
  createdAt         DateTime  @default(now())
  revokedAt         DateTime?

  /// ip åœ°å€ä¸ user-agentï¼ˆå¯é€‰ï¼Œç”¨äºå®¡è®¡ï¼‰
  ip        String?
  userAgent String?

  @@index([userId])
  @@index([revoked, expiresAt])
  @@index([revoked, revokedAt])
}

/// è®°å½•å„ç±»åŒæ­¥ä»»åŠ¡çš„æ¸¸æ ‡ä¸çŠ¶æ€
/// å…¼å®¹å¤šæ¥æºä¸å¤šä»»åŠ¡ï¼Œé€šè¿‡ (source, key) å”¯ä¸€å®šä½ã€‚
model SyncState {
  id String @id @default(uuid())

  /// åŒæ­¥æ¥æºï¼šä¾‹å¦‚ 'github:stars'
  source String

  /// ä»»åŠ¡é”®ï¼šä¾‹å¦‚ 'user:YOUR_GITHUB_USERNAME'
  key String

  /// ç”¨äºå¢é‡åŒæ­¥çš„æ¸¸æ ‡ï¼ˆä¾‹å¦‚ GitHub starred_at çš„ ISO å­—ç¬¦ä¸²ï¼‰
  cursor String? // e.g. "2025-09-01T05:11:22Z"

  /// HTTP ETagï¼ˆIf-None-Match/304ï¼‰ï¼Œå¯é€‰åŠ é€Ÿ
  etag String?

  /// æœ€è¿‘ä¸€æ¬¡è¿è¡Œæ—¶é—´/æˆåŠŸæ—¶é—´/å¤±è´¥æ—¶é—´
  lastRunAt     DateTime?
  lastSuccessAt DateTime?
  lastErrorAt   DateTime?

  /// æœ€è¿‘ä¸€æ¬¡é”™è¯¯ä¿¡æ¯ï¼ˆç®€è¦ï¼‰
  lastError String?

  /// æœ€è¿‘ä¸€æ¬¡ç»Ÿè®¡ä¿¡æ¯ï¼ˆJSON ä¸²ï¼Œè®°å½• created/updated ç­‰ï¼‰
  statsJson String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([source, key]) // ä¸€ä¸ªæ¥æº+é”®åªä¿ç•™ä¸€æ¡çŠ¶æ€
  @@index([source])
  @@index([updatedAt])
}

/// å½’æ¡£çš„ Project å¿«ç…§ï¼ˆå…è®¸åŒä¸€ githubId å¤šæ¬¡å½’æ¡£ï¼‰
model ArchivedProject {
  id                String         @id @default(uuid())
  /// GitHub é¡¹ç›® IDï¼ˆéå”¯ä¸€ï¼Œå…è®¸å¤šæ¬¡å½’æ¡£ï¼‰
  githubId          Int?
  originalProjectId String?
  /// å½’æ¡£ç†ç”±
  reason            ArchivedReason
  /// å½’æ¡£æ—¶çš„å®Œæ•´é¡¹ç›®ä¿¡æ¯å¿«ç…§ï¼ˆJSONï¼‰
  snapshot          Json
  archivedAt        DateTime       @default(now())

  @@index([githubId])
  @@index([archivedAt])
  @@index([reason])
}
